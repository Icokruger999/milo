{
  "InstanceIds": ["i-06bc5b2218c041802"],
  "DocumentName": "AWS-RunShellScript",
  "Comment": "Deploy backend from GitHub",
  "TimeoutSeconds": 600,
  "Parameters": {
    "commands": [
      "#!/bin/bash",
      "echo '========================================'",
      "echo 'Deploying Milo Backend from GitHub'",
      "echo '========================================'",
      "echo ''",
      "export HOME=/home/ec2-user",
      "export DOTNET_CLI_HOME=/home/ec2-user",
      "cd ~",
      "REPO_DIR=\"$HOME/milo-repo\"",
      "if [ -d \"$REPO_DIR\" ]; then",
      "  echo 'Updating repository...'",
      "  cd \"$REPO_DIR\"",
      "  git pull origin main",
      "else",
      "  echo 'Cloning repository...'",
      "  git clone https://github.com/Icokruger999/milo.git \"$REPO_DIR\"",
      "  cd \"$REPO_DIR\"",
      "fi",
      "echo ''",
      "echo 'Building backend...'",
      "cd \"$REPO_DIR/backend/Milo.API\"",
      "dotnet restore",
      "dotnet publish -c Release -o /var/www/milo-api",
      "echo ''",
      "echo 'Setting permissions...'",
      "sudo chown -R ec2-user:ec2-user /var/www/milo-api",
      "sudo chmod -R 755 /var/www/milo-api",
      "echo ''",
      "echo 'Stopping old backend process...'",
      "sudo pkill -f 'Milo.API.dll' || echo 'No process to stop'",
      "sleep 2",
      "echo 'Setting up systemd service...'",
      "sudo tee /etc/systemd/system/milo-api.service > /dev/null <<EOF",
      "[Unit]",
      "Description=Milo API",
      "After=network.target",
      "[Service]",
      "Type=simple",
      "ExecStart=/usr/bin/dotnet /var/www/milo-api/Milo.API.dll --urls http://localhost:5001",
      "Restart=always",
      "RestartSec=10",
      "KillSignal=SIGINT",
      "SyslogIdentifier=milo-api",
      "User=ec2-user",
      "Environment=ASPNETCORE_ENVIRONMENT=Production",
      "Environment=ASPNETCORE_URLS=http://localhost:5001",
      "[Install]",
      "WantedBy=multi-user.target",
      "EOF",
      "echo 'Restarting service...'",
      "sudo systemctl daemon-reload",
      "sudo systemctl enable milo-api",
      "sudo systemctl restart milo-api",
      "sleep 5",
      "echo ''",
      "echo 'Testing API...'",
      "curl -s http://localhost:5001/api/health",
      "echo ''",
      "curl -s http://localhost:5001/api/flakes",
      "echo ''",
      "echo 'Deployment Complete!'"
    ]
  }
}

