{
  "InstanceIds": ["i-06bc5b2218c041802"],
  "DocumentName": "AWS-RunShellScript",
  "Parameters": {
    "commands": [
      "echo 'Step 1: Backup current DLL'",
      "sudo cp /home/ec2-user/milo-backend-publish/Milo.API.dll /home/ec2-user/milo-backend-publish/Milo.API.dll.backup-before-mailkit",
      "echo 'Step 2: Install .NET SDK if not present'",
      "which dotnet || sudo yum install -y dotnet-sdk-8.0",
      "echo 'Step 3: Clone repo to temp location'",
      "cd /tmp && rm -rf milo-temp && git clone https://github.com/Icokruger999/milo.git milo-temp",
      "cd /tmp/milo-temp",
      "echo 'Step 4: Inject MailKit fix into EmailService.cs'",
      "sed -i '1,10s|using Amazon.SimpleEmail;|using MailKit.Net.Smtp;|' backend/Milo.API/Services/EmailService.cs",
      "sed -i '1,10s|using Amazon.SimpleEmail.Model;|using MimeKit;|' backend/Milo.API/Services/EmailService.cs",
      "sed -i 's|private readonly bool _useSes;|// Removed SES|' backend/Milo.API/Services/EmailService.cs",
      "sed -i 's|private readonly IAmazonSimpleEmailService? _sesClient;|// Removed SES client|' backend/Milo.API/Services/EmailService.cs",
      "echo 'Step 5: Remove AWS SDK from csproj'",
      "sed -i '/<PackageReference Include=\"AWSSDK.SimpleEmail\"/d' backend/Milo.API/Milo.API.csproj",
      "echo 'Step 6: Build'",
      "cd backend/Milo.API && dotnet publish -c Release -o /tmp/milo-publish",
      "echo 'Step 7: Deploy new DLL'",
      "sudo systemctl stop milo-backend",
      "sudo cp /tmp/milo-publish/Milo.API.dll /home/ec2-user/milo-backend-publish/Milo.API.dll",
      "sudo systemctl start milo-backend",
      "sleep 3",
      "curl -s http://localhost:8080/api/health"
    ]
  }
}
