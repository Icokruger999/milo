{
  "InstanceIds": ["i-06bc5b2218c041802"],
  "DocumentName": "AWS-RunShellScript",
  "Comment": "Create Flakes table via SQL",
  "Parameters": {
    "commands": [
      "#!/bin/bash",
      "echo 'Creating Flakes table in database...'",
      "echo ''",
      "# Get connection string from appsettings",
      "cd /var/www/milo-api",
      "CONN_STRING=$(cat appsettings.json | grep -A 1 'DefaultConnection' | tail -1 | cut -d'\"' -f4)",
      "echo 'Connection string found'",
      "echo ''",
      "# Extract database details",
      "DB_HOST=$(echo $CONN_STRING | grep -oP 'Host=\\K[^;]+')",
      "DB_NAME=$(echo $CONN_STRING | grep -oP 'Database=\\K[^;]+')",
      "DB_USER=$(echo $CONN_STRING | grep -oP 'Username=\\K[^;]+')",
      "DB_PASS=$(echo $CONN_STRING | grep -oP 'Password=\\K[^;]+')",
      "echo \"Connecting to: $DB_HOST / $DB_NAME\"",
      "echo ''",
      "# Check if table exists",
      "TABLE_EXISTS=$(PGPASSWORD=$DB_PASS psql -h $DB_HOST -U $DB_USER -d $DB_NAME -t -c \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'Flakes');\" 2>/dev/null | tr -d ' ')",
      "if [ \"$TABLE_EXISTS\" = \"t\" ]; then",
      "  echo 'Flakes table already exists'",
      "else",
      "  echo 'Creating Flakes table...'",
      "  PGPASSWORD=$DB_PASS psql -h $DB_HOST -U $DB_USER -d $DB_NAME << 'EOF'",
      "CREATE TABLE \"Flakes\" (",
      "    \"Id\" SERIAL PRIMARY KEY,",
      "    \"Title\" VARCHAR(500) NOT NULL,",
      "    \"Content\" TEXT,",
      "    \"ProjectId\" INTEGER,",
      "    \"AuthorId\" INTEGER,",
      "    \"CreatedAt\" TIMESTAMP NOT NULL,",
      "    \"UpdatedAt\" TIMESTAMP,",
      "    \"IsDeleted\" BOOLEAN NOT NULL DEFAULT FALSE,",
      "    CONSTRAINT \"FK_Flakes_Projects_ProjectId\" FOREIGN KEY (\"ProjectId\") REFERENCES \"Projects\"(\"Id\") ON DELETE CASCADE,",
      "    CONSTRAINT \"FK_Flakes_Users_AuthorId\" FOREIGN KEY (\"AuthorId\") REFERENCES \"Users\"(\"Id\") ON DELETE SET NULL",
      ");",
      "CREATE INDEX \"IX_Flakes_ProjectId\" ON \"Flakes\" (\"ProjectId\");",
      "CREATE INDEX \"IX_Flakes_AuthorId\" ON \"Flakes\" (\"AuthorId\");",
      "EOF",
      "  echo 'Flakes table created successfully'",
      "fi",
      "echo ''",
      "echo 'Restarting service...'",
      "sudo systemctl restart milo-api",
      "sleep 3",
      "echo ''",
      "echo 'Testing flakes endpoint...'",
      "curl -s http://localhost:5001/api/flakes",
      "echo ''",
      "echo 'Done!'"
    ]
  }
}

