    {
        try
        {
            var emailSubject = $"New Incident Assigned: {incidentNumber} - {subject}";
            var link = incidentLink ?? "https://www.codingeverest.com/milo-incidents.html";
            var priorityColor = priority.ToLower() switch
            {
                "high" or "urgent" => "#DE350B",
                "medium" => "#FF991F",
                _ => "#6B778C"
            };
            var statusColor = status.ToLower() switch
            {
                "new" => "#6554C0",
                "open" => "#0052CC",
                "resolved" => "#36B37E",
                "closed" => "#36B37E",
                _ => "#6B778C"
            };
            
            // Build details section dynamically
            var detailsHtml = new StringBuilder();
            detailsHtml.AppendLine($@"
                        <div class='detail-item'>
                            <div class='detail-label'>Priority</div>
                            <div class='detail-value'><span class='priority-badge'>{priority}</span></div>
                        </div>
                        <div class='detail-item'>
                            <div class='detail-label'>Status</div>
                            <div class='detail-value'><span class='status-badge'>{status}</span></div>
                        </div>");
            
            if (!string.IsNullOrWhiteSpace(requesterName))
            {
                var requesterText = requesterName;
                if (!string.IsNullOrWhiteSpace(requesterEmail))
                    requesterText += $" ({requesterEmail})";
                detailsHtml.AppendLine($@"
                        <div class='detail-item'>
                            <div class='detail-label'>Requester</div>
                            <div class='detail-value'>{requesterText}</div>
                        </div>");
            }
            
            if (createdAt.HasValue)
            {
                detailsHtml.AppendLine($@"
                        <div class='detail-item'>
                            <div class='detail-label'>Created</div>
                            <div class='detail-value'>{createdAt.Value:MMM dd, yyyy HH:mm} UTC</div>
                        </div>");
            }
            
            if (!string.IsNullOrWhiteSpace(category))
            {
                detailsHtml.AppendLine($@"
                        <div class='detail-item'>
                            <div class='detail-label'>Category</div>
                            <div class='detail-value'>{category}</div>
                        </div>");
            }
            
            if (!string.IsNullOrWhiteSpace(source))
            {
                detailsHtml.AppendLine($@"
                        <div class='detail-item'>
                            <div class='detail-label'>Source</div>
                            <div class='detail-value'>{source}</div>
                        </div>");
            }
            
            var descriptionHtml = "";
            var descriptionText = "";
            if (!string.IsNullOrWhiteSpace(description))
            {
                var escapedDescription = description.Replace("&", "&amp;").Replace("<", "&lt;").Replace(">", "&gt;");
                descriptionHtml = $@"
                    <div style='margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(223, 225, 230, 0.6);'>
                        <div class='detail-label'>Description</div>
                        <div style='font-size: 14px; color: #42526E; line-height: 1.6; margin-top: 8px; white-space: pre-wrap;'>{escapedDescription}</div>
                    </div>";
                descriptionText = $"\n\nDescription:\n{description}";
            }
            
            // Build plain text version
            var plainTextDetails = new StringBuilder();
            plainTextDetails.AppendLine($"Priority: {priority}");
            plainTextDetails.AppendLine($"Status: {status}");
            if (!string.IsNullOrWhiteSpace(requesterName))
            {
                var requesterText = requesterName;
                if (!string.IsNullOrWhiteSpace(requesterEmail))
                    requesterText += $" ({requesterEmail})";
                plainTextDetails.AppendLine($"Requester: {requesterText}");
            }
            if (createdAt.HasValue)
            {
                plainTextDetails.AppendLine($"Created: {createdAt.Value:MMM dd, yyyy HH:mm} UTC");
            }
            if (!string.IsNullOrWhiteSpace(category))
            {
                plainTextDetails.AppendLine($"Category: {category}");
            }
            if (!string.IsNullOrWhiteSpace(source))
            {
                plainTextDetails.AppendLine($"Source: {source}");
            }
            
            var plainTextBody = $@"Hello {assigneeName},

A new incident has been assigned to you and requires your attention:

{incidentNumber} - {subject}

{plainTextDetails.ToString().Trim()}{descriptionText}

View incident details: {link}

This is an automated notification from Milo Incident Management
Please review and respond to this incident as soon as possible.";
            
            var htmlBody = $@"
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #172B4D; background: linear-gradient(135deg, #F4F5F7 0%, #EBECF0 100%); margin: 0; padding: 20px; -webkit-font-smoothing: antialiased; }}
        .email-wrapper {{ max-width: 600px; margin: 0 auto; }}
        .container {{ background-color: #FFFFFF; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(9, 30, 66, 0.15), 0 0 1px rgba(9, 30, 66, 0.1); }}
        .header {{ background: linear-gradient(135deg, #0052CC 0%, #0747A6 100%); color: #FFFFFF; padding: 40px 32px; text-align: center; position: relative; }}
        .header::after {{ content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%); }}
        .header h1 {{ font-size: 28px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }}
        .content {{ padding: 40px 32px; }}
        .greeting {{ font-size: 16px; color: #172B4D; margin-bottom: 16px; }}
        .intro-text {{ font-size: 15px; color: #42526E; margin-bottom: 24px; line-height: 1.6; }}
        .incident-box {{ background: linear-gradient(to bottom, #F8F9FA 0%, #F4F5F7 100%); border-left: 5px solid #0052CC; padding: 24px; margin: 24px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(9, 30, 66, 0.08); }}
        .incident-number {{ font-size: 16px; font-weight: 700; color: #0052CC; margin-bottom: 12px; letter-spacing: 0.5px; text-transform: uppercase; }}
        .incident-subject {{ font-size: 22px; font-weight: 700; color: #172B4D; margin-bottom: 20px; line-height: 1.4; }}
        .incident-details {{ display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(223, 225, 230, 0.6); }}
        .detail-item {{ }}
        .detail-label {{ font-size: 11px; color: #6B778C; text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }}
        .detail-value {{ font-size: 15px; font-weight: 600; color: #172B4D; }}
        .priority-badge, .status-badge {{ display: inline-block; padding: 6px 14px; border-radius: 6px; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }}
        .priority-badge {{ background: {priorityColor}20; color: {priorityColor}; border: 1px solid {priorityColor}40; }}
        .status-badge {{ background: {statusColor}20; color: {statusColor}; border: 1px solid {statusColor}40; }}
        .cta-container {{ text-align: center; margin: 32px 0; }}
        .cta-button {{ display: inline-block; background: linear-gradient(135deg, #0052CC 0%, #0065FF 100%); color: #FFFFFF; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(0, 82, 204, 0.3); transition: all 0.2s ease; border: none; }}
        .cta-button:hover {{ box-shadow: 0 6px 16px rgba(0, 82, 204, 0.4); transform: translateY(-1px); }}
        .footer {{ background: #F4F5F7; padding: 32px; text-align: center; border-top: 1px solid #DFE1E6; }}
        .footer p {{ font-size: 13px; color: #6B778C; margin: 8px 0; line-height: 1.5; }}
        .footer p:first-child {{ font-weight: 600; color: #42526E; }}
        @media only screen and (max-width: 600px) {{
            .content {{ padding: 32px 24px; }}
            .incident-details {{ grid-template-columns: 1fr; gap: 16px; }}
            .header {{ padding: 32px 24px; }}
            .header h1 {{ font-size: 24px; }}
        }}
    </style>
</head>
<body>
    <div class='email-wrapper'>
        <div class='container'>
            <div class='header'>
                <h1>Incident Assigned to You</h1>
            </div>
            <div class='content'>
                <p class='greeting'>Hello {assigneeName},</p>
                <p class='intro-text'>A new incident has been assigned to you and requires your attention:</p>
                <div class='incident-box'>
                    <div class='incident-number'>{incidentNumber}</div>
                    <div class='incident-subject'>{subject}</div>
                    <div class='incident-details'>
{detailsHtml.ToString().Trim()}
                    </div>
{descriptionHtml}
                </div>
                <div class='cta-container'>
                    <a href='{link}' class='cta-button'>View Incident Details</a>
                </div>
            </div>
            <div class='footer'>
                <p>This is an automated notification from Milo Incident Management</p>
                <p>Please review and respond to this incident as soon as possible.</p>
            </div>
        </div>
    </div>
</body>
</html>";

            return await SendEmailWithPlainTextAsync(email, emailSubject, htmlBody, plainTextBody);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error sending incident assignment email to {Email}", email);
            return false;
        }
    }

    public async Task<bool> SendNewUserNotificationEmailAsync(string userEmail, string userName, DateTime signupDate)
    {
        try
        {
            var adminEmail = "ico@astutetech.co.za";
            var subject = $"New User Signed Up: {userName}";
            
            // Get frontend URL from configuration
            var frontendUrl = _configuration["Frontend:Url"] ?? "https://www.codingeverest.com";
            var link = $"{frontendUrl}/milo-board.html";
            
            // Simple HTML body with just a link (like project invitations)
            var htmlBody = $@"
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
</head>
<body>
    <p>A new user has signed up and successfully logged in to Milo:</p>
    <p><strong>{System.Net.WebUtility.HtmlEncode(userName)}</strong> ({System.Net.WebUtility.HtmlEncode(userEmail)})</p>
    <p>Signed up: {signupDate:yyyy-MM-dd HH:mm:ss} UTC</p>
    <p><a href='{link}'>View in Milo</a></p>
</body>
</html>";

            // Plain text version
            var plainTextBody = $@"A new user has signed up and successfully logged in to Milo:

{userName} ({userEmail})
Signed up: {signupDate:yyyy-MM-dd HH:mm:ss} UTC

View in Milo: {link}";

            return await SendEmailWithPlainTextAsync(adminEmail, subject, htmlBody, plainTextBody);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error sending new user notification email");
            return false;
        }
    }

    public async Task<bool> SendDailyUsersReportEmailAsync(string recipientEmail, List<UserReportData> users)
    {
        try
        {
                var subject = $"Daily Milo Users Report - {DateTime.UtcNow.AddHours(2):yyyy-MM-dd}";
            
