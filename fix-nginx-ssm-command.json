{
  "InstanceIds": ["i-06bc5b2218c041802"],
  "DocumentName": "AWS-RunShellScript",
  "Comment": "Fix nginx backend connection",
  "Parameters": {
    "commands": [
      "#!/bin/bash",
      "echo '========================================'",
      "echo 'Fixing nginx Backend Connection'",
      "echo '========================================'",
      "echo ''",
      "echo 'Checking backend service...'",
      "if curl -s http://localhost:5001/api/health > /dev/null; then",
      "  echo 'Backend is running on port 5001'",
      "else",
      "  echo 'Backend is NOT running on port 5001'",
      "  echo 'Starting backend service...'",
      "  sudo systemctl start milo-api",
      "  sudo systemctl enable milo-api",
      "  sleep 2",
      "fi",
      "echo ''",
      "echo 'Checking SELinux status...'",
      "if command -v getenforce &> /dev/null; then",
      "  SELINUX_STATUS=$(getenforce)",
      "  echo \"SELinux status: $SELINUX_STATUS\"",
      "  if [ \"$SELINUX_STATUS\" != \"Disabled\" ]; then",
      "    echo 'Allowing nginx to connect to network (SELinux)...'",
      "    sudo setsebool -P httpd_can_network_connect 1",
      "    echo 'SELinux permission granted'",
      "  fi",
      "else",
      "  echo 'SELinux not installed'",
      "fi",
      "echo ''",
      "echo 'Restarting nginx...'",
      "sudo systemctl restart nginx",
      "sudo systemctl enable nginx",
      "sleep 2",
      "echo ''",
      "echo 'Testing connection...'",
      "curl -s http://localhost:5001/api/health",
      "echo ''",
      "curl -s http://localhost/api/health",
      "echo ''",
      "echo 'Fix Complete!'",
      "echo 'Test: https://api.codingeverest.com/api/health'"
    ]
  }
}

