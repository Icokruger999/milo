{
    "Parameters": {
        "commands": [
            "cd /home/ec2-user/milo",
            "echo 'Resetting git...'",
            "sudo -u ec2-user git reset --hard HEAD",
            "sudo -u ec2-user git clean -fd",
            "echo 'Pulling latest...'",
            "sudo -u ec2-user git pull origin main",
            "echo 'Checking MiloDbContext...'",
            "grep -A 2 'ToTable.*incidents' /home/ec2-user/milo/backend/Milo.API/Data/MiloDbContext.cs || echo 'NOT FOUND'",
            "echo 'Building...'",
            "cd /home/ec2-user/milo/backend/Milo.API",
            "sudo -u ec2-user dotnet publish -c Release -o /home/ec2-user/milo-backend-publish",
            "echo 'Restarting...'",
            "killall -9 dotnet || echo 'No processes'",
            "sleep 3",
            "cd /home/ec2-user/milo-backend-publish",
            "nohup dotnet Milo.API.dll --urls http://0.0.0.0:5001 > /home/ec2-user/backend.log 2>&1 &",
            "sleep 5",
            "ps aux | grep 'Milo.API.dll' | grep -v grep"
        ]
    }
}
